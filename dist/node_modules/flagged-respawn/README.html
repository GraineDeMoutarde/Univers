<h1>flagged-respawn <a href="http://travis-ci.org/js-cli/js-flagged-respawn"><img src="https://secure.travis-ci.org/js-cli/js-flagged-respawn.svg" alt="Build Status"></a></h1>
<blockquote>
<p>A tool for respawning node binaries when special flags are present.</p>
</blockquote>
<p><a href="https://nodei.co/npm/flagged-respawn/"><img src="https://nodei.co/npm/flagged-respawn.png" alt="NPM"></a></p>
<h2>What is it?</h2>
<p>Say you wrote a command line tool that runs arbitrary javascript (e.g. task runner, test framework, etc). For the sake of discussion, let's pretend it's a testing harness you've named <code>testify</code>.</p>
<p>Everything is going splendidly until one day you decide to test some code that relies on a feature behind a v8 flag in node (<code>--harmony</code>, for example).  Without much thought, you run <code>testify --harmony spec tests.js</code>.</p>
<p>It doesn't work. After digging around for a bit, you realize this produces a <a href="http://nodejs.org/docs/latest/api/process.html#process_process_argv"><code>process.argv</code></a> of:</p>
<p><code>['node', '/usr/local/bin/test', '--harmony', 'spec', 'tests.js']</code></p>
<p>Crap. The <code>--harmony</code> flag is in the wrong place! It should be applied to the <strong>node</strong> command, not our binary. What we actually wanted was this:</p>
<p><code>['node', '--harmony', '/usr/local/bin/test', 'spec', 'tests.js']</code></p>
<p>Flagged-respawn fixes this problem and handles all the edge cases respawning creates, such as:</p>
<ul>
<li>Providing a method to determine if a respawn is needed.</li>
<li>Piping stderr/stdout from the child into the parent.</li>
<li>Making the parent process exit with the same code as the child.</li>
<li>If the child is killed, making the parent exit with the same signal.</li>
</ul>
<p>To see it in action, clone this repository and run <code>npm install</code> / <code>npm run respawn</code> / <code>npm run nospawn</code>.</p>
<h2>Sample Usage</h2>
<pre><code class="language-js">#!/usr/bin/env node

const flaggedRespawn = require('flagged-respawn');

// get a list of all possible v8 flags for the running version of node
const v8flags = require('v8flags').fetch();

flaggedRespawn(v8flags, process.argv, function (ready, child) {
  if (ready) {
    console.log('Running!');
    // your cli code here
  } else {
    console.log('Special flags found, respawning.');
  }
  if (process.pid !== child.pid) {
    console.log('Respawned to PID:', child.pid);
  }
});

</code></pre>
<h2>API</h2>
<h3>&lt;u&gt;flaggedRespawn(flags, argv, [ forcedFlags, ] callback) : Void&lt;/u&gt;</h3>
<p>Respawns the script itself when <em>argv</em> has special flag contained in <em>flags</em> and/or <em>forcedFlags</em> is not empty. Because members of <em>flags</em> and <em>forcedFlags</em> are passed to <code>node</code> command, each of them needs to be a node flag or a V8 flag.</p>
<h4>Forbid respawning</h4>
<p>If <code>--no-respawning</code> flag is given in <em>argv</em>, this function does not respawned even if <em>argv</em> contains members of flags or <em>forcedFlags</em> is not empty. (This flag is also used internally to prevent from respawning more than once).</p>
<h4>Parameter:</h4>
<table>
<thead>
<tr>
<th style="text-align:left">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><em>flags</em></td>
<td style="text-align:center">Array</td>
<td style="text-align:left">An array of node flags and V8 flags which are available when present in <em>argv</em>.</td>
</tr>
<tr>
<td style="text-align:left"><em>argv</em></td>
<td style="text-align:center">Array</td>
<td style="text-align:left">Command line arguments to respawn.</td>
</tr>
<tr>
<td style="text-align:left"><em>forcedFlags</em></td>
<td style="text-align:center">Array or String</td>
<td style="text-align:left">An array of node flags or a string of a single flag and V8 flags for respawning forcely.</td>
</tr>
<tr>
<td style="text-align:left"><em>callback</em></td>
<td style="text-align:center">function</td>
<td style="text-align:left">A called function when not respawning or after respawned.</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>&lt;u&gt;&lt;i&gt;callback&lt;/i&gt;(ready, proc, argv) : Void&lt;/u&gt;</strong></p>
<p><em>callback</em> function is called both when respawned or not, and it can be distinguished by callback's argument: <em>ready</em>. (<em>ready</em> indicates whether a process spawned its child process (false) or not (true), but it does not indicate whether a process is a spawned child process or not. <em>ready</em> for a spawned child process is true.)</p>
<p><em>argv</em> is an array of command line arguments which is respawned (when <em>ready</em> is false) or is passed current process except flags within <em>flags</em> and <code>--no-respawning</code> (when <em>ready</em> is true).</p>
<p><strong>Parameter:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><em>ready</em></td>
<td style="text-align:center">boolean</td>
<td style="text-align:left">True, if not respawning and is ready to execute main function.</td>
</tr>
<tr>
<td style="text-align:left"><em>proc</em></td>
<td style="text-align:center">object</td>
<td style="text-align:left">Child process object if respawned, otherwise current process object.</td>
</tr>
<tr>
<td style="text-align:left"><em>argv</em></td>
<td style="text-align:center">Array</td>
<td style="text-align:left">An array of command line arguments.</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h2>Release History</h2>
<ul>
<li>2017-12-16 - v1.0.0 - Force/Forbid respawn, Improved API &amp; testing</li>
<li>2016-03-22 - v0.3.2 - fix issue with v8 flags values being dropped</li>
<li>2014-09-12 - v0.3.1 - use <code>{ stdio: 'inherit' }</code> for spawn to maintain colors</li>
<li>2014-09-11 - v0.3.0 - for real this time</li>
<li>2014-09-11 - v0.2.0 - cleanup</li>
<li>2014-09-04 - v0.1.1 - initial release</li>
</ul>
